DATABASE = 'database/mydatabase.db'
merchant={
"UNKOWN":"âš æœªçŸ¥çš„å•†å®¶âš ï¸",
"KFC":"å¿«é¤ğŸ±", 
"AZUMA":"å¿«é¤ğŸ±", 
"Burger":"å¿«é¤ğŸ±", 
"Go Loc":"å•†åº—ğŸ¬", 
"Abdul":"å•†åº—ğŸ¬",
"W M MO":"å•†åº—ğŸ¬Morrisons",
"GYOZA":"ä¸­é¤ğŸ¥Ÿ",
"PEACE":"ä¸­é¤ğŸ¥Ÿå’Œå¹³èŠ±å›­",
"Peace":"ä¸­é¤ğŸ¥Ÿå’Œå¹³èŠ±å›­",
"SumUP":"ç¬¬ä¸‰æ–¹æ”¯ä»˜",
"SumUp":"ç¬¬ä¸‰æ–¹æ”¯ä»˜",
"COSTCU":"å•†åº—ğŸ¬",
"MAX SP":"ç…§ç›¸ğŸ“·",
"TESCO":"å•†åº—ğŸ¬",
"WAITRO":"å•†åº—ğŸ¬",
"ASDA H":"å•†åº—ğŸ¬",
"Lycamo":"è¿è¥å•†ğŸ“±",
"TRINIT":"å¥èº«æˆ¿ğŸ‹ï¸",
"LONDON":"ä¼¦æ•¦Oyster, åœ°ä¸‹é“åŠå…¬å…±äº¤é€š",
"TRAINP":"ç«è½¦ç¥¨/æ±½è½¦ç¥¨/é£æœºç¥¨",
"GOOGLE":"Googleçº¿ä¸Šæ‰£æ¬¾",
"MCDONA":"å¿«é¤ğŸ±",
"WWW.BL":"Bloomberg",
"Red Ch":"ä¸­é¤ğŸ¥Ÿçº¢è¾£æ¤’ğŸŒ¶ï¸",
"BOLT.E":"æ‰“è½¦ğŸš–",
"HUNGRY":"ç†ŠçŒ«å¤–å–ğŸ¼",
"Jimmy?":"é¤é¥®ğŸ¦",
"SH UK":"é¤é¥®ğŸ¦",
"ARCHIE":"é¤é¥®ğŸ¦",
"BABYLO":"é¤é¥®ğŸ¦",
"Zettle":"ç¬¬ä¸‰æ–¹æ”¯ä»˜,é¤é¥®é›¶å”®",
"Taste":"å•†åº—ğŸ¬æ’æ˜‡è¡Œ",
"STGCOA":"å…¬å…±äº¤é€šğŸšŒStagecoach",
"SQ *SN":"é¤é¥®ğŸ¦",
"Hungry":"ç†ŠçŒ«å¤–å–ğŸ¼",
"Red Re":"ä¸­é¤ğŸ¥Ÿ",
"Vue Ci":"ğŸ¬ç”µå½±é™¢ğŸ¦",
"Google":"Googleçº¿ä¸Šæ‰£æ¬¾",
"WRIGHT":"é¤é¥®ğŸ¦",
"SWEET":"å°åº—ğŸ“¦VictoriaCoachStation",
"HUMAN":"å…±äº«è‡ªè¡Œè½¦ğŸš´",
"PANOPO":"å°åº—ğŸ“¦",
"NYA*Sh":"å°åº—ğŸ“¦",
"MARKS*":"å¿«é¤ğŸ±", 
"Fetton":"é¤é¥®ğŸ¦",
"VISA A":"ç¾å›½ç­¾è¯åŠç†è´¹ç”¨ğŸ‡ºğŸ‡¸",
"LYCAMO":"è¿è¥å•†ğŸ“±",
"THE MI":"å°åº—ğŸ“¦",
"SQ *DO":"é¤é¥®ğŸ¦",
"THE NA":"å•†åº—ğŸ¬",
"MAMA T":"é¤é¥®ğŸ¦",
"AMZNMk":"äºšé©¬é€ŠğŸ›ï¸",
"SQ *TA":"é¤é¥®ğŸ¦",
"NYA*Be":"å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"AMAZON":"äºšé©¬é€ŠğŸ›ï¸",
"AMZNMK":"äºšé©¬é€ŠğŸ›ï¸",
"BERYL*":"å…±äº«è‡ªè¡Œè½¦ğŸš´",
"BERYL":"å…±äº«è‡ªè¡Œè½¦ğŸš´",
"UOM ST":"å­¦è´¹ğŸ«",
"MY MAN":"å­¦è´¹ğŸ«",
"UOM PR":"å­¦è´¹ğŸ«",
"UOM AC":"å­¦è´¹ğŸ«",
"RAILCA":"Rail Card",
"SAFEST":"ä»“åº“safestore.co.uk",
"CLOUDF":"Cloudflareè¾¹ç¼˜åŠ é€ŸèŠ‚ç‚¹",
"DVSA":"Driving Standards Agency",
"HOLLAN":"ä¿å¥å“hollandandbarrett.com",
"CHICKE":"å¿«é¤ğŸ±",
"NETIM":"åŸŸåæ³¨å†Œå•†netim.com",
"NAVARR":"é¤é¥®ğŸ¦",
"CONNEC":"å¯èƒ½æ˜¯å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"TEAM B":"å¯èƒ½æ˜¯é¤é¥®ğŸ¦",
"NAVARR":"é¤é¥®ğŸ¦",
"SPAR P":"å¯èƒ½æ˜¯å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"WASABI":"é¤é¥®ğŸ¦wasabi.uk.com",
"ONE HO":"å•†åº—ğŸ¬",
"MOSSBA":"å¯èƒ½æ˜¯å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"GRAND":"å¿«é¤ğŸ±",
"One Pl":"é¤é¥®ğŸ¦",
"GOVIN":"å¯èƒ½æ˜¯å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"RED CH":"ä¸­é¤ğŸ¥Ÿçº¢è¾£æ¤’ğŸŒ¶ï¸",
"Dixy":"å¿«é¤ğŸ±",
"LIDL G":"å•†åº—ğŸ¬lidl.co.uk",
"POUNDL":"å•†åº—ğŸ¬Poundland",
"One Pl":"é¤é¥®ğŸ¦",
"ZTL*VN":"å¯èƒ½æ˜¯å•†åº—ğŸ¬",
"SHORYU":"é¤é¥®ğŸ¦",
"iZ *Un":"å¯èƒ½æ˜¯å°åº—ğŸ“¦æˆ–è‡ªåŠ¨å”®è´§æœº",
"PP*785":"Paypal"



}

import sqlite3, re, json
from flask import Flask, render_template, request, jsonify, Blueprint
from datetime import datetime, timedelta
from functions.standardtime import timestamp_to_datetime

if __name__ == '__main__':
    app_bank = Flask(__name__)
else:
    app_bank=Blueprint('app_bank', __name__)

def merchant_classification(merchant_name):
    if merchant_name=="":
        return merchant_name
    try:
        merchant_type=merchant[merchant_name]
        return(f"{merchant_name}({merchant_type})")
    except Exception:
        return merchant_name
    
def get_timestamp_range(year, month):
    try:
        year = int(year)
        month = int(month)

        if 1 <= month <= 12:
            start_date = datetime(year, month, 1)
            
            # å•ç‹¬å¤„ç†12æœˆï¼Œé¿å…åˆ›å»ºä¸‹ä¸€å¹´çš„æœˆä»½ä¸º13
            if month == 12:
                end_date = datetime(year + 1, 1, 1) - timedelta(seconds=1)
            else:
                end_date = datetime(year, month + 1, 1) - timedelta(seconds=1)
            
            start_timestamp = int(start_date.timestamp())
            end_timestamp = int(end_date.timestamp())
            return start_timestamp, end_timestamp
        else:
            print("Error in plugin_bank.py=>get_timestamp_range, æœˆä»½å¿…é¡»åœ¨1åˆ°12ä¹‹é—´")
            return False
    except ValueError as e:
        print(f"Error in plugin_bank.py=>get_timestamp_range, æ— æ•ˆçš„å¹´ä»½æˆ–æœˆä»½è¾“å…¥: {e}")
        return False

class Bank():
    def __init__(self):
        self.DB=DATABASE
    def parseCreditCardTransactions(self, content, ts=""):
        try:
            card_number=content[content.find("ä¿¡ç”¨å¡")+3:content.find("äº")]
            if "äº¤æ˜“å¤±è´¥" in content or "é¢„æˆæƒ" in content :
                merchant="";amount=""
            elif "ç½‘é“¶" in content:
                merchant="";amount=""
            elif "æ¶ˆè´¹" in content:
                merchant=content[content.find("åœ¨")+1:content.find("æ¶ˆè´¹")]
                amount=content[content.find("æ¶ˆè´¹")+2:content.find("å…ƒ")]
                direction=-1
            elif "æ’¤é”€" in content:
                merchant=content[content.find("åœ¨")+1:content.find("æ’¤é”€")]
                if merchant=="":
                    merchant="æ’¤é”€æ”¯ä»˜"
                amount=content[content.find("æ’¤é”€")+2:content.find("å…ƒ")]
                direction=1
            elif "å­˜å…¥" in content:
                merchant=content[content.find("åœ¨")+1:content.find("å­˜å…¥")]
                amount=content[content.find("å­˜å…¥")+2:content.find("å…ƒ")]
                direction=1
            elif "æˆåŠŸé€€è´§" in content:
                merchant=""
                amount=content[content.find("æˆåŠŸé€€è´§")+4:content.find("å…ƒ")]
                direction=1
            else:
                merchant="";amount=""
            if merchant=="":
                merchant="UNKOWN"
            merchant=merchant_classification(merchant)
            if amount!="":
                unit=amount[:3]
                amount=direction*float(amount[3:].replace(",","").replace(" ",""))
                return{"status":True,"ts":ts, "card_number":card_number,"merchant":merchant,"amount":amount, "unit":unit}
            
            return{"status":False,"detail":content}
        except Exception as ex:
            #print(ex);
            return{"status":False,"detail":ex}
            
    def readBankMessagesFromDB(self):
        conn = sqlite3.connect(self.DB)
        cursor = conn.cursor()
        query = """
        SELECT timestamp, content
        FROM messages
        WHERE content LIKE '%æ‚¨çš„ä¿¡ç”¨å¡%'
        """
        try:
            cursor.execute(query)
            results = cursor.fetchall()
            res=[]
            for row in results:
                #print(f"Timestamp: {row[0]}, Content: {row[1]}")
                #print(row)
                #print(self.parseCreditCardTransactions(row[1],ts=row[0]))
                after_parse=self.parseCreditCardTransactions(row[1],ts=row[0])
                if after_parse["status"]==True:
                    res.append(after_parse)
                else:
                    #print(after_parse)
                    pass
        finally:
            conn.close()
            return res


@app_bank.route('/bank/chart/<year>')
def web_bank_chart(year):
    try:
        #year=request.args.get('year')
        final_unit = request.args.get('unit')
        
        if final_unit:
            final_unit=final_unit.upper()
        #return f"Received month value: {month}"
        labels = []
        data=[]
        if year:
            year=int(year)
        else:
            return jsonify({"status":False, "detail":"Year not given"})
        if 2000<=year<=9999:
            transactions=Bank().readBankMessagesFromDB()
            for m in range(1,13):
                #print(get_timestamp_range(year,m))
                from_date, to_date=get_timestamp_range(year,m)
                res=[]
                for u in transactions:
                    if from_date<=float(u["ts"])<=to_date:
                        res.append(u)
                res_sum=0
                for v in res:
                    if v["unit"]=="GBP":
                        unit=9
                    elif v["unit"]=="CNY":
                        unit=1
                    elif v["unit"]=="HKD":
                        unit=1,1
                    elif v["unit"]=="USD":
                        unit=7
                    elif v["unit"]=="EUR":
                        unit=8
                    else:
                        unit=1
                    res_sum+=float(v["amount"])*unit
                if final_unit=="CNY":
                    pass
                elif final_unit=="GBP":
                    res_sum=res_sum/9
                elif final_unit=="USD":
                    res_sum=res_sum/7
                else:
                    pass
                labels.append(f'{m}')
                data.append(res_sum)
            #return all
            if final_unit==None or final_unit=="":
                final_unit="CNY"
            return render_template('chart.html', labels=labels, data=data, final_unit="Amount in "+final_unit, year=year, unit=final_unit)
        else:
            return jsonify({"status":False, "detail":"Invalid year or month range: 2000<=year<=9999, 1<=month<=12, /sum/<year>/<month>?unit=USD"})
    except ValueError:
        return jsonify({"status":False, "detail":"Invalid month value. Please provide a valid integer for month."})


    # å‡†å¤‡æ•°æ®ç»™Chart.js
    #labels = sorted(monthly_sums.keys())  # ç¡®ä¿æ ‡ç­¾æ˜¯æ’åºçš„
    #data = [monthly_sums[month] for month in labels]

    # æ¸²æŸ“HTMLæ¨¡æ¿
    #return render_template('chart.html', labels=json.dumps(labels), data=json.dumps(data))


@app_bank.route('/bank/list/<year>/<month>')
def web_bank_list(year, month):
    try:
        #month = request.args.get('month')
        #return f"Received month value: {month}"
        
        year=int(year); month=int(month)
        if 2000<=year<=9999 and 1<=month<=12:
            transactions=Bank().readBankMessagesFromDB()
            from_date, to_date=get_timestamp_range(year,month)
            res=[]
            for u in transactions:
                if from_date<=float(u["ts"])<=to_date:
                    res.append(u)
            return jsonify(res)
        else:
            return jsonify({"status":False, "detail":"Invalid year or month range: 2000<=year<=9999, 1<=month<=12, /sum/<year>/<month>"})
    except ValueError:
        return jsonify({"status":False, "detail":"Invalid month value. Please provide a valid integer for month."})


@app_bank.route('/bank/sum/<year>/<month>')
def web_sum(year, month):
    try:
        final_unit = request.args.get('unit')
        if final_unit:
            final_unit = final_unit.upper()

        year = int(year)
        month = int(month)

        if 2000 <= year <= 9999 and 1 <= month <= 12:
            transactions = Bank().readBankMessagesFromDB()
            from_date, to_date = get_timestamp_range(year, month)

            res = []
            for u in transactions:
                if from_date <= float(u["ts"]) <= to_date:
                    res.append(u)

            res_sum = 0
            for v in res:
                if v["unit"] == "GBP":
                    unit = 9
                elif v["unit"] == "CNY":
                    unit = 1
                elif v["unit"] == "HKD":
                    unit = 1.1
                elif v["unit"] == "USD":
                    unit = 7
                elif v["unit"] == "EUR":
                    unit = 8
                else:
                    unit = 1

                res_sum += float(v["amount"]) * unit

            response_data = {"status": True, "amount": res_sum}

            if final_unit == "CNY":
                response_data["unit"] = "CNY"
                return jsonify(response_data)
            elif final_unit == "GBP":
                response_data["unit"] = "GBP"
                response_data["amount"] /= 9
                return jsonify(response_data)
            elif final_unit == "USD":
                response_data["unit"] = "USD"
                response_data["amount"] /= 7
                return jsonify(response_data)
            else:
                response_data["unit"] = "CNY"
                response_data["info"] = "unit allowed: CNY, GBP, USD. CNY as default. /sum/<year>/<month>?unit=USD"
                return jsonify(response_data)

        else:
            return jsonify({"status": False, "detail": "Invalid year or month range: 2000<=year<=9999, 1<=month<=12, /sum/<year>/<month>?unit=USD"})

    except ValueError:
        return jsonify({"status": False, "detail": "Invalid month value. Please provide a valid integer for month."})

if __name__ == '__main__':
    app_bank.run(debug=True, port=12300)